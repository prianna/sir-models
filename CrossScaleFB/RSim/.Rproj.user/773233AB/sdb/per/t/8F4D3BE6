{
    "contents" : "################################\n################################\n## the cross scale simulator\n## with fixed bottle neck\n## created 12/2013 by Sebastian Schreiber\n################################\n################################\n\n# basic idea of the model is that are k viral strains that compete within any infected host. The within-host dynamics of these viral strains is specified by the within.host function (e.g. a linear model with ceiling below for illustrative purposes). An infected host begins with an initial viral load N. For a host with a given viral load that has made a contact with an infected individual, the function transmission uses multinomial sampling to determines the initial viral load in the contacted individual. Finally, the function between.host runs the full dynamics by tracking each generation of infected hosts. These infected hosts can infect others for T units. During these T units of time, they may contacts at a rate beta and transmit succesfully acording to the prob.transmission function.\n\n# need the following library to compute the matrix exponential \n\nlibrary(Matrix)\n\n# global parameters\n\nr=c(0.1,0.11) # within host per-capita growth rates\nb=c(1,2) # weights for determining transmission\nK=10000 # within-host carrying capacity\nk=2 # number of viral types\nmu=0.001 #mutation rate\nN=100 # initial viral load size\nT=15 # length of infection\nbeta=5 # contact rate\n\n##############################\n# the within host function\n##############################\n# input: initial condition v, vector of times \n# output: list with matrix with viral numbers at the desired times \n# this within host model gives exponential growth until the population hits the maximal viral load N at which time the dynamics are normalized.\n\nwithin.host=function(v,times){  \n  M=matrix(0,k,k) # mutation matrix (one steps to the right)\n  M[-1,-k]=diag(k-1)*mu\n  A=M+diag(r) # the viral dynamic matrix\n  \n  \n  L=length(times) # number of evaluations\n  k=length(v) # number of viral types\n  V=matrix(0,k,L) # matrix for output; columns are the viral loads at the specified times. \n  \n  for(i in 1:L){\n    temp=as.matrix(expm(A*times[i])%*%v);\n    if(sum(temp)>K)temp=K*temp/sum(temp) # normalize if viral load is greater than N\n    V[,i]=temp\n  }\n  return(list(V=V))\n}\n\n\n\n\n############################\n# single strain R0 function\n############################\n# input: nada\n# output: R0 (vector)\n# computes the R0s for the single strains \n# NOTE: If the function transmission is changed below, it also needs to be changed here. \nR.naught=function(){\n  R=numeric(k)\n  \n  for(i in 1:k){\n    S=function(t)1-exp(-b[i]*pmin(N*exp(r[i]*t),K)/N) \n    R[i]=beta*(integrate(S,0,T)$value)\n  }\n  return(R)\t\n}\n\n\n\n\n\n###################################\n# the transmission functions\n###################################\n# input: matrix of viral column vectors\n# output: viral type of newly infected\n\ntransmission=function(V,n){\n  V.weighted=diag(b)%*%V\n  if(n>1)V.weighted=V.weighted%*%diag(1/colSums(V.weighted))\n  if(n==1)V.weighted=V.weighted/sum(V.weighted)\n  W=c()\n  for(i in 1:n)W=cbind(W,rmultinom(n=1,size=N,prob=V.weighted[,i]))\n  return(W)\n}\n\n\n# input: matrix of viral column distribution vectors\n# output: viral type of newly infected\n\nprob.transmission=function(V)1-exp(-colSums(diag(b)%*%V)/N)\n\n#######################################\n# between host dynamics (the cross scale model)\n########################################\n# input: initial infected type v, maximum cases\n# output: list with who (who infected this individual, 0 for case 1), when (when was this individual infected), type (matrix of types)\n\nbetween.host=function(v,cases){\n  type=matrix(v,k,1) # holds the intial viral types for all individuals; dynamically increased by adding columns. \n  who=c(0) # vector of who was the parent of the infected individual\n  when=c(0) # when the individual was initially infected\n  gen=c(0) # generation when individual was infected\n  total=1 # total cases\n  current=1 # current cases\n  gen.count=1\n  \n  while(total<(cases+1)&&current>0){\n    # next line determines the number of contacts each individual in the current generation has with other individuals \n    kids=rpois(n=current,lambda=beta*T)\n    # the next loop determines at what times the contact events occur, the transmission of viral particles, and removes any instances where transmitted load is zero\n    for(i in 1:current){ # loop for all individuals in current generation\n      if(kids[i]>0){ # if current individual has a positive number of contacts do the following \n        v.start=type[,total-current+i] # get the initial viral load of the current individual \n        t=runif(kids[i])*T # find the times at which the contact events occur\n        out=within.host(v.start,t) # find the viral load at the contact events \n        v.out=out$V\n        success=rbinom(kids[i],1,prob=prob.transmission(v.out)) # which transmissions where succesful\n        w=transmission(v.out,kids[i])*success # find the transmitted viral load at these contact events\n        viral.counts=colSums(w) # find the total viral load due to the transmission events\n        positive=which(viral.counts>0) # find which transmission events included a positive number of viral particles\n        if(length(positive)>0){ # if there were some real transmission events do the following\n          who=c(who,rep(total-current+i,length(positive))) # make the current individual the parent of all the newly infected individuals \n          mom.when=when[total-current+i] # find the time when mom was infected. \n          when=c(when,t[positive]+mom.when) # add the times at which the newly infected individuals got infected\n          \n          type=cbind(type,w[,positive]) # add the types for the newly infected individuals \n          kids[i]=length(positive) # reset kids[i] to the number of newly infected individuals\t\n        }\n        if(length(positive)==0)kids[i]=0 # reset kids[i] when there where no infections\n        \n      }\n    }\n    gen=c(gen,rep(gen.count,sum(kids))) # add the generation times for all the newly infected individuals for the current generation \n    current=sum(kids) # update the count for the current number of infected individuals \n    total=total+current # update the count for the cummulative number of infected individuals\n    gen.count=gen.count+1 # increate the generation count\n    \n  }\n  \n  return(list(when=when,who=who,type=type,gen=gen))\n  \n  \n}",
    "created" : 1389242227453.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2647472304",
    "id" : "8F4D3BE6",
    "lastKnownWriteTime" : 1389242764,
    "path" : "~/Documents/Courses/SIRModels/CrossScaleFB/RSim/CrossScaleFB.R",
    "project_path" : "CrossScaleFB.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : true,
    "type" : "r_source"
}